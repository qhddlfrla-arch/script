/**
 * gemini-service.js
 * Google Gemini APIë¥¼ í†µí•œ ì‹¤ì œ ëŒ€ë³¸ ìƒì„± ëª¨ë“ˆ
 */

const GeminiService = {
    MODEL: 'gemini-2.0-flash-lite',

    /**
     * API ì—”ë“œí¬ì¸íŠ¸ ìƒì„±
     */
    getEndpoint(apiKey) {
        return `https://generativelanguage.googleapis.com/v1beta/models/${this.MODEL}:generateContent?key=${apiKey}`;
    },

    /**
     * ì˜ìƒ ê¸¸ì´ë³„ ì§€ì¹¨ ê°€ì ¸ì˜¤ê¸°
     */
    getDurationGuidelines(durationMinutes) {
        const durationMap = {
            10: {
                label: '10ë¶„',
                charCount: 'ì•½ 2,000ìž',
                guidelines: 'ê°„ê²°í•˜ë©´ì„œë„ í•µì‹¬ì„ ë‹´ì€ ëŒ€ë³¸ì„ ìž‘ì„±í•˜ì„¸ìš”. ê° ì£¼ì œëŠ” 1-2ê°œ ë¬¸ë‹¨ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.'
            },
            20: {
                label: '20ë¶„',
                charCount: 'ì•½ 4,000ìž',
                guidelines: 'ì ë‹¹í•œ ê¹Šì´ë¡œ ì£¼ì œë¥¼ ë‹¤ë£¨ë˜, ê° ì£¼ì œë§ˆë‹¤ ì˜ˆì‹œë¥¼ 1-2ê°œì”© í¬í•¨í•˜ì„¸ìš”.'
            },
            30: {
                label: '30ë¶„',
                charCount: 'ì•½ 6,000ìž',
                guidelines: 'ì‹¬ì¸µ ë¶„ì„ ìˆ˜ì¤€ìž…ë‹ˆë‹¤. ê° ì±•í„°ë§ˆë‹¤ êµ¬ì²´ì ì¸ ì‚¬ë¡€(Case Study)ë¥¼ 3ê°€ì§€ ì´ìƒ ë“¤ê³ , ë‚´ìš©ì„ ê¹Šì´ ìžˆê²Œ íŒŒê³ ë“œì„¸ìš”. í†µê³„ë‚˜ ì—°êµ¬ ê²°ê³¼ë„ ì¸ìš©í•˜ì„¸ìš”.'
            },
            60: {
                label: '1ì‹œê°„',
                charCount: 'ì•½ 12,000ìž',
                guidelines: 'ê°•ì˜/ë‹¤íë©˜í„°ë¦¬ê¸‰ ê¹Šì´ìž…ë‹ˆë‹¤. ëª¨ë“  ì£¼ì œì— ëŒ€í•´ ìƒì„¸í•œ ë°°ê²½ ì„¤ëª…, ë‹¤ì–‘í•œ ê´€ì  ë¶„ì„, ì‹¤ì œ ì‚¬ë¡€ 5ê°œ ì´ìƒ, ì „ë¬¸ê°€ ì˜ê²¬, ê·¸ë¦¬ê³  ì‹¤ìŠµ ê°€ì´ë“œê¹Œì§€ í¬í•¨í•˜ì„¸ìš”. ê° ì„¹ì…˜ì„ ì—¬ëŸ¬ í•˜ìœ„ ì£¼ì œë¡œ ì„¸ë¶„í™”í•˜ì„¸ìš”.'
            },
            90: {
                label: '1ì‹œê°„ 30ë¶„',
                charCount: 'ì•½ 18,000ìž',
                guidelines: 'í’€ ë²„ì „ìž…ë‹ˆë‹¤. ë§ˆìŠ¤í„°í´ëž˜ìŠ¤ ìˆ˜ì¤€ì˜ ì™„ì „í•œ ê°•ì˜ ëŒ€ë³¸ì„ ìž‘ì„±í•˜ì„¸ìš”. ì—­ì‚¬ì  ë°°ê²½, ì´ë¡ ì  ê¸°ì´ˆ, ì‹¤ì œ ì ìš© ì‚¬ë¡€ 10ê°œ ì´ìƒ, í”í•œ ì‹¤ìˆ˜ì™€ í•´ê²°ì±…, Q&A ì˜ˆìƒ ì§ˆë¬¸, ê·¸ë¦¬ê³  ì‹¬í™” í•™ìŠµ ìžë£Œê¹Œì§€ ëª¨ë‘ í¬í•¨í•˜ì„¸ìš”. ìµœëŒ€í•œ ìƒì„¸í•˜ê²Œ ìž‘ì„±í•˜ë˜ ì§€ë£¨í•˜ì§€ ì•Šê²Œ ìŠ¤í† ë¦¬í…”ë§ì„ í™œìš©í•˜ì„¸ìš”.'
            }
        };

        return durationMap[durationMinutes] || durationMap[10];
    },

    /**
     * í”„ë¡¬í”„íŠ¸ ìƒì„± (ì˜ìƒ ê¸¸ì´ ë°˜ì˜ + ê³ í€„ë¦¬í‹° ì§€ì¹¨)
     */
    getPrompt(originalScript, durationMinutes) {
        const duration = this.getDurationGuidelines(durationMinutes);

        return `# ðŸŽ¬ íŽ˜ë¥´ì†Œë‚˜ ì„¤ì •
ë„ˆëŠ” **êµ¬ë…ìž 100ë§Œ ëª…ì„ ë³´ìœ í•œ ì „ë¬¸ ìŠ¤í† ë¦¬í…”ëŸ¬ ìœ íŠœë²„**ì•¼.
ì§€ë£¨í•œ ì„¤ëª…ë¬¸ ëŒ€ì‹ , ì‹œì²­ìžì™€ ëŒ€í™”í•˜ëŠ” ë“¯í•œ **'êµ¬ì–´ì²´'**ë¥¼ ì™„ë²½í•˜ê²Œ êµ¬ì‚¬í•´.
ë§ˆì¹˜ ì¹œí•œ í˜•/ëˆ„ë‚˜ê°€ ê¿€íŒì„ ì•Œë ¤ì£¼ëŠ” ê²ƒì²˜ëŸ¼ ì¹œê·¼í•˜ë©´ì„œë„ ì „ë¬¸ì ì¸ í†¤ì„ ìœ ì§€í•´.

---

# ðŸŽ¯ ëª©í‘œ ì˜ìƒ ê¸¸ì´
- ì„ íƒëœ ì˜ìƒ ê¸¸ì´: **${duration.label}** (${duration.charCount})
- ${duration.guidelines}
- ë‹¨ìˆœ ìš”ì•½ì´ ì•„ë‹ˆë¼, ì‹¤ì œ ë§í•˜ëŠ” ì†ë„(ë¶„ë‹¹ 200ìž ê¸°ì¤€)ë¡œ ì½ì—ˆì„ ë•Œ ${duration.label}ì´ ë‚˜ì˜¬ ë¶„ëŸ‰ì„ ìž‘ì„±í•´.

---

# âœ¨ ê³ í€„ë¦¬í‹° ìž‘ì„± ì§€ì¹¨ (í•„ìˆ˜!)

## 1. ê°•ë ¥í•œ ë„ìž…ë¶€ (ì´íƒˆ ë°©ì§€)
- **ì˜¤í”„ë‹ 5ì´ˆ**: ì‹œì²­ìžê°€ ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ ë§Œë“œëŠ” ì¶©ê²©ì ì¸ í•œ ë§ˆë”” ë˜ëŠ” ì§ˆë¬¸
- **ì˜¤í”„ë‹ 30ì´ˆ**: ì‹œì²­ìžì˜ ê³ ë¯¼ì— ê³µê°í•˜ëŠ” 'ê³µê° í¬ì¸íŠ¸' + ì´ ì˜ìƒì„ ëê¹Œì§€ ë´ì•¼ í•˜ëŠ” ì´ìœ 
- ì˜ˆì‹œ: "ì†”ì§ížˆ ë§í• ê²Œìš”. ì €ë„ 3ë…„ ì „ì—ëŠ” ì—¬ëŸ¬ë¶„ê³¼ ë˜‘ê°™ì•˜ì–´ìš”..."

## 2. êµ¬ì²´ì ì¸ ì˜ˆì‹œ (ì¶”ìƒì  ì„¤ëª… ê¸ˆì§€!)
- ëª¨ë“  ì„¤ëª…ì—ëŠ” ë°˜ë“œì‹œ **êµ¬ì²´ì ì¸ ì‚¬ë¡€, ìˆ«ìž, ê²½í—˜ë‹´**ì„ í¬í•¨í•´
- âŒ ë‚˜ìœ ì˜ˆ: "ë…¸ë ¥í•˜ë©´ ì„±ê³µí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤"
- âœ… ì¢‹ì€ ì˜ˆ: "ì œê°€ ì‹¤ì œë¡œ 6ê°œì›” ë™ì•ˆ ë§¤ì¼ 30ë¶„ì”© íˆ¬ìží•´ì„œ ì›” ìˆ˜ìµ 300ë§Œ ì›ì„ ë‹¬ì„±í•œ ë°©ë²•ì„ ì•Œë ¤ë“œë¦´ê²Œìš”"

## 3. êµ¬ì¡°í™”ëœ ì¶œë ¥ í˜•ì‹
ì•„ëž˜ í˜•ì‹ì„ **ë°˜ë“œì‹œ** ë”°ë¼ ìž‘ì„±í•´:

---

**1. ì´ì•¼ê¸°ê¾¼:** (ì§„í–‰ìžì˜ í†¤/ìŠ¤íƒ€ì¼ - ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸ ìœ íŠœë²„)

**2. ì˜¤í”„ë‹ 5ì´ˆ:**
   - ê°•ë ¥í•œ í›„í‚¹ ë¬¸ìž¥: (ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ í•˜ëŠ” ì¶©ê²©ì ì¸ í•œ ë§ˆë””)

**3. ì˜¤í”„ë‹ 30ì´ˆ:**
   - ë¬¸ì œ ì œê¸° â†’ ê¸°ëŒ€ê° ìœ ë„: (ì‹œì²­ìžê°€ "ë‚˜ë„ ê·¸ëž˜!" í•˜ê³  ê³µê°í•  ë¬¸ì œ ìƒí™©)
   - ì‹œì²­ìž íƒ€ê¹ƒ ì§ì ‘ ì§€ëª©: (ì´ ì˜ìƒì´ ëˆ„êµ¬ë¥¼ ìœ„í•œ ê²ƒì¸ì§€ ëª…í™•ížˆ)
   - ì½˜í…ì¸  ì˜ˆê³ : (ì˜¤ëŠ˜ ì•Œë ¤ì¤„ í•µì‹¬ ë¹„ë²• ë¯¸ë¦¬ë³´ê¸°)
   - ë¸Œë¦¿ì§€ ë¬¸ìž¥: (ë³¸ë¡ ìœ¼ë¡œ ìžì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°)

**4. ë³¸ë¡  - í•µì‹¬ ë¹„ë²• 1:**
   - ì†Œì£¼ì œ ì œëª©: (í¥ë¯¸ë¡œìš´ ì†Œì œëª©)
   - ì´ë¡  ì„¤ëª…: (ì™œ ì´ê²Œ ì¤‘ìš”í•œì§€)
   - **ì‹¤ì œ ì ìš© ì˜ˆì‹œ**: (êµ¬ì²´ì ì¸ ì‚¬ë¡€, ìˆ«ìž, ê²½í—˜ë‹´ í•„ìˆ˜!)
   - ì‹œì²­ìž í–‰ë™ ìœ ë„: (ì§€ê¸ˆ ë°”ë¡œ í•´ë³¼ ìˆ˜ ìžˆëŠ” ê²ƒ)

**5. ë¸Œë¦¿ì§€ ë¬¸ìž¥:** (ë‹¤ìŒ ë¹„ë²•ìœ¼ë¡œ ìžì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°)

**6. ë³¸ë¡  - í•µì‹¬ ë¹„ë²• 2:**
   - ì†Œì£¼ì œ ì œëª©:
   - ì´ë¡  ì„¤ëª…:
   - **ì‹¤ì œ ì ìš© ì˜ˆì‹œ**: (êµ¬ì²´ì ì¸ ì‚¬ë¡€ í•„ìˆ˜!)
   - ì‹œì²­ìž í–‰ë™ ìœ ë„:

**7. ë¸Œë¦¿ì§€ ë¬¸ìž¥:**

**8. ë³¸ë¡  - í•µì‹¬ ë¹„ë²• 3:**
   - ì†Œì£¼ì œ ì œëª©:
   - ì´ë¡  ì„¤ëª…:
   - **ì‹¤ì œ ì ìš© ì˜ˆì‹œ**: (êµ¬ì²´ì ì¸ ì‚¬ë¡€ í•„ìˆ˜!)
   - ì‹œì²­ìž í–‰ë™ ìœ ë„:

**9. í´ë¡œì§•:**
   - **í•œ ì¤„ ìš”ì•½**: (ì˜¤ëŠ˜ ë‚´ìš©ì„ í•œ ë¬¸ìž¥ìœ¼ë¡œ ì •ë¦¬)
   - **ê°ì„±ì  ë…ë ¤**: (ì‹œì²­ìžë¥¼ ê²©ë ¤í•˜ëŠ” ì§„ì‹¬ ì–´ë¦° ë©”ì‹œì§€)
   - **êµ¬ë… ìœ ë„**: âœ… êµ¬ë…ê³¼ ì¢‹ì•„ìš”, ì•Œë¦¼ ì„¤ì • ë¶€íƒ + ëŒ“ê¸€ë¡œ ì†Œí†µ ìœ ë„

---

## 4. ê°€ë…ì„± ë†’ì´ê¸°
- ì¤‘ìš”í•œ í‚¤ì›Œë“œëŠ” **êµµê²Œ** í‘œì‹œí•´
- ë¬¸ë‹¨ ì‚¬ì´ì—ëŠ” ì¤„ë°”ê¿ˆì„ ë„‰ë„‰ížˆ ë„£ì–´ì„œ ì½ê¸° íŽ¸í•˜ê²Œ í•´
- ë¦¬ìŠ¤íŠ¸ë‚˜ ë²ˆí˜¸ë¥¼ í™œìš©í•´ì„œ êµ¬ì¡°ë¥¼ ëª…í™•ížˆ í•´

## 5. ë§íˆ¬ ì˜ˆì‹œ
- "ìž, ì—¬ëŸ¬ë¶„" / "ì†”ì§ížˆ ë§í• ê²Œìš”" / "ì´ê±° ì§„ì§œ ì¤‘ìš”í•´ìš”"
- "ì œê°€ ì§ì ‘ í•´ë´¤ëŠ”ë°ìš”" / "ë§Žì€ ë¶„ë“¤ì´ ì´ê±¸ ë†“ì¹˜ì„¸ìš”"
- "ê·¼ë° ì—¬ê¸°ì„œ ë°˜ì „ì´ ìžˆì–´ìš”" / "ì´ê²Œ í•µì‹¬ì´ì—ìš”!"

---

# ðŸ“ ë¶„ì„í•  ê¸°ì¡´ ëŒ€ë³¸

ì•„ëž˜ ëŒ€ë³¸ì„ ë¶„ì„í•´ì„œ, í•µì‹¬ ì£¼ì œì™€ ìŠ¤íƒ€ì¼ì„ íŒŒì•…í•œ ë’¤
**${duration.label} ë¶„ëŸ‰**ì˜ ê³ í€„ë¦¬í‹° ëŒ€ë³¸ì„ ìƒˆë¡­ê²Œ ìž‘ì„±í•´ì¤˜.

[ê¸°ì¡´ ëŒ€ë³¸]
${originalScript}

---

âš ï¸ ì¤‘ìš”: ìœ„ì˜ ê³ í€„ë¦¬í‹° ì§€ì¹¨ì„ **ëª¨ë‘** ë°˜ì˜í•´ì„œ ìž‘ì„±í•´.
ì§§ì€ ì˜ìƒì´ë¼ë„ **ìž„íŒ©íŠ¸ ìžˆê³ , êµ¬ì²´ì ì´ê³ , ì‹œì²­ìžê°€ ëê¹Œì§€ ë³´ê³  ì‹¶ì–´í•˜ëŠ”** ëŒ€ë³¸ì„ ë§Œë“¤ì–´ì¤˜!`;
    },

    /**
     * Google Gemini API í˜¸ì¶œ
     */
    async generate(originalScript, apiKey, durationMinutes = 10) {
        try {
            const controller = new AbortController();
            // ê¸´ ëŒ€ë³¸ì€ ì‹œê°„ì´ ì˜¤ëž˜ ê±¸ë¦´ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ íƒ€ìž„ì•„ì›ƒ ëŠ˜ë¦¼
            const timeoutMs = durationMinutes >= 30 ? 180000 : 60000; // 30ë¶„ ì´ìƒ: 3ë¶„, ê·¸ ì™¸: 1ë¶„
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            const response = await fetch(this.getEndpoint(apiKey), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: this.getPrompt(originalScript, durationMinutes)
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: durationMinutes >= 60 ? 16000 : 8000,
                        temperature: 0.85
                    }
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API ì˜¤ë¥˜: ${response.status}`);
            }

            const data = await response.json();

            // Gemini API ì‘ë‹µ ê²½ë¡œ: data.candidates[0].content.parts[0].text
            const generatedText = data.candidates[0].content.parts[0].text;

            // ì‘ë‹µì—ì„œ ì£¼ì œ ì¶”ì¶œ
            const topic = this.extractTopic(generatedText, originalScript);

            return {
                topic,
                script: generatedText
            };

        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
            console.error('Gemini API ì˜¤ë¥˜:', error);
            throw error;
        }
    },

    /**
     * ìƒì„±ëœ í…ìŠ¤íŠ¸ì—ì„œ ì£¼ì œ ì¶”ì¶œ
     */
    extractTopic(generatedText, originalScript) {
        // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ì¶”ì¶œ
        const words = originalScript.split(/\s+/).filter(word => word.length > 2);
        const commonWords = ['ì•ˆë…•í•˜ì„¸ìš”', 'ì—¬ëŸ¬ë¶„', 'ì˜¤ëŠ˜', 'ì˜ìƒ', 'êµ¬ë…', 'ì¢‹ì•„ìš”', 'ê°ì‚¬', 'ì´ë²ˆ'];
        const filtered = words.filter(word => !commonWords.includes(word));

        let keyword = 'ì½˜í…ì¸ ';
        if (filtered.length > 0) {
            keyword = filtered[Math.floor(Math.random() * Math.min(3, filtered.length))];
        }

        // ì£¼ì œ í…œí”Œë¦¿
        const templates = [
            `${keyword} ì™„ë²½ ê°€ì´ë“œ`,
            `${keyword}ì˜ ëª¨ë“  ê²ƒ`,
            `${keyword} ë§ˆìŠ¤í„°í•˜ê¸°`,
            `${keyword} ì‹¤ì „ í™œìš©ë²•`
        ];

        return templates[Math.floor(Math.random() * templates.length)];
    },

    /**
     * API í‚¤ ìœ íš¨ì„± ê°„ë‹¨ ê²€ì‚¬
     */
    isValidKeyFormat(apiKey) {
        return apiKey && apiKey.length > 20;
    }
};
